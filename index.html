<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BBL Liegenschaftsinventar - Korrekturen</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Mapbox GL JS CSS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet">

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

  <!-- ApexCharts -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <!-- CSS -->
  <link rel="stylesheet" href="css/tokens.css">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo">
      <img src="assets/swiss-logo-flag.svg" alt="Schweizerische Eidgenossenschaft" class="logo-flag">
      <div class="logo-text">
        <div class="logo-text-primary">Bundesamt für Bauten und Logistik</div>
        <div class="logo-text-secondary">Korrekturen Liegenschaftsinventar</div>
      </div>
    </div>

    <nav class="nav-tabs">
      <button class="nav-tab active" data-tab="karte">Karte</button>
      <button class="nav-tab" data-tab="aufgaben">Aufgaben</button>
      <button class="nav-tab" data-tab="statistik">Statistik</button>
      <button class="nav-tab" data-tab="settings">Einstellungen & Workflows</button>
    </nav>

    <div class="header-actions">
      <div class="search-container" id="search-container">
        <button class="search-toggle" id="search-toggle" type="button">
          <i data-lucide="search" class="icon"></i>
        </button>
        <input type="text" class="search-input" placeholder="Ort suchen..." id="globalSearch" autocomplete="off">
        <button class="search-clear" id="search-clear" type="button">
          <i data-lucide="x" class="icon-sm"></i>
        </button>
        <div class="search-dropdown" id="search-dropdown">
          <div class="search-results" id="search-results"></div>
        </div>
      </div>
      <button class="filter-toggle active" id="filter-toggle" type="button">
        <i data-lucide="sliders-horizontal" class="icon"></i>
      </button>
      <div class="user-avatar">MK</div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Global Filter Bar -->
    <div class="filter-bar" id="filter-bar">
      <div class="filter-chips">
        <button class="filter-chip" data-filter="high">
          <i data-lucide="chevrons-up" class="icon-sm"></i>
          <span>Hoch</span>
          <span class="count" id="count-high">(0)</span>
        </button>
        <button class="filter-chip" data-filter="medium">
          <i data-lucide="chevron-up" class="icon-sm"></i>
          <span>Mittel</span>
          <span class="count" id="count-medium">(0)</span>
        </button>
        <button class="filter-chip" data-filter="low">
          <i data-lucide="minus" class="icon-sm"></i>
          <span>Niedrig</span>
          <span class="count" id="count-low">(0)</span>
        </button>
      </div>
      <div class="filter-divider"></div>
      <button class="filter-chip" data-filter="my-tasks">Meine Aufgaben</button>
      <div class="filter-divider"></div>

      <!-- Multi-select: Kanton -->
      <div class="multi-select" id="filter-kanton">
        <button class="multi-select-trigger" type="button">
          <span class="multi-select-label">Kanton</span>
          <i data-lucide="chevron-down" class="icon-sm"></i>
        </button>
        <div class="multi-select-dropdown">
          <div class="multi-select-actions">
            <button type="button" class="multi-select-action" data-action="all">Alle</button>
            <button type="button" class="multi-select-action" data-action="none">Keine</button>
          </div>
          <div class="multi-select-options">
            <label class="multi-select-option"><input type="checkbox" value="TG"><span>TG</span></label>
            <label class="multi-select-option"><input type="checkbox" value="SG"><span>SG</span></label>
            <label class="multi-select-option"><input type="checkbox" value="ZH"><span>ZH</span></label>
            <label class="multi-select-option"><input type="checkbox" value="BE"><span>BE</span></label>
            <label class="multi-select-option"><input type="checkbox" value="GR"><span>GR</span></label>
            <label class="multi-select-option"><input type="checkbox" value="LU"><span>LU</span></label>
            <label class="multi-select-option"><input type="checkbox" value="GE"><span>GE</span></label>
            <label class="multi-select-option"><input type="checkbox" value="TI"><span>TI</span></label>
            <label class="multi-select-option"><input type="checkbox" value="BS"><span>BS</span></label>
          </div>
        </div>
      </div>

      <!-- Multi-select: Konfidenz -->
      <div class="multi-select" id="filter-confidence">
        <button class="multi-select-trigger" type="button">
          <span class="multi-select-label">Konfidenz</span>
          <i data-lucide="chevron-down" class="icon-sm"></i>
        </button>
        <div class="multi-select-dropdown">
          <div class="multi-select-actions">
            <button type="button" class="multi-select-action" data-action="all">Alle</button>
            <button type="button" class="multi-select-action" data-action="none">Keine</button>
          </div>
          <div class="multi-select-options">
            <label class="multi-select-option"><input type="checkbox" value="critical"><span>Kritisch</span></label>
            <label class="multi-select-option"><input type="checkbox" value="warning"><span>Warnung</span></label>
            <label class="multi-select-option"><input type="checkbox" value="ok"><span>OK</span></label>
          </div>
        </div>
      </div>

      <!-- Multi-select: Portfolio -->
      <div class="multi-select" id="filter-portfolio">
        <button class="multi-select-trigger" type="button">
          <span class="multi-select-label">Portfolio</span>
          <i data-lucide="chevron-down" class="icon-sm"></i>
        </button>
        <div class="multi-select-dropdown">
          <div class="multi-select-actions">
            <button type="button" class="multi-select-action" data-action="all">Alle</button>
            <button type="button" class="multi-select-action" data-action="none">Keine</button>
          </div>
          <div class="multi-select-options">
            <label class="multi-select-option"><input type="checkbox" value="Büro"><span>Büro</span></label>
            <label class="multi-select-option"><input type="checkbox" value="Wohnen"><span>Wohnen</span></label>
            <label class="multi-select-option"><input type="checkbox" value="Öffentlich"><span>Öffentlich</span></label>
            <label class="multi-select-option"><input type="checkbox" value="Industrie"><span>Industrie</span></label>
            <label class="multi-select-option"><input type="checkbox" value="Bildung"><span>Bildung</span></label>
          </div>
        </div>
      </div>

      <!-- Multi-select: Status -->
      <div class="multi-select" id="filter-status">
        <button class="multi-select-trigger" type="button">
          <span class="multi-select-label">Status</span>
          <i data-lucide="chevron-down" class="icon-sm"></i>
        </button>
        <div class="multi-select-dropdown">
          <div class="multi-select-actions">
            <button type="button" class="multi-select-action" data-action="all">Alle</button>
            <button type="button" class="multi-select-action" data-action="none">Keine</button>
          </div>
          <div class="multi-select-options">
            <label class="multi-select-option"><input type="checkbox" value="backlog"><span>Backlog</span></label>
            <label class="multi-select-option"><input type="checkbox" value="inprogress"><span>In Bearbeitung</span></label>
            <label class="multi-select-option"><input type="checkbox" value="clarification"><span>Abklärung</span></label>
            <label class="multi-select-option"><input type="checkbox" value="done"><span>Erledigt</span></label>
          </div>
        </div>
      </div>

      <!-- Multi-select: Zugewiesen -->
      <div class="multi-select" id="filter-assignee">
        <button class="multi-select-trigger" type="button">
          <span class="multi-select-label">Zugewiesen</span>
          <i data-lucide="chevron-down" class="icon-sm"></i>
        </button>
        <div class="multi-select-dropdown">
          <div class="multi-select-actions">
            <button type="button" class="multi-select-action" data-action="all">Alle</button>
            <button type="button" class="multi-select-action" data-action="none">Keine</button>
          </div>
          <div class="multi-select-options">
            <label class="multi-select-option"><input type="checkbox" value="M. Keller"><span>M. Keller</span></label>
            <label class="multi-select-option"><input type="checkbox" value="S. Brunner"><span>S. Brunner</span></label>
            <label class="multi-select-option"><input type="checkbox" value="T. Weber"><span>T. Weber</span></label>
            <label class="multi-select-option"><input type="checkbox" value="A. Meier"><span>A. Meier</span></label>
            <label class="multi-select-option"><input type="checkbox" value=""><span>Nicht zugewiesen</span></label>
          </div>
        </div>
      </div>

      <div class="filter-divider"></div>
      <button class="filter-reset-btn" id="filter-reset" type="button">
        <i data-lucide="rotate-ccw" class="icon-sm"></i>
        <span>Zurücksetzen</span>
      </button>

      <div class="filter-spacer"></div>
      <div class="filter-total" id="filter-total">
        <span id="filtered-count">0</span> / <span id="total-count">0</span> Gebäude
      </div>
    </div>

    <!-- Content with shared detail panel -->
    <div class="content-with-panel">
      <div class="tabs-content">

    <!-- Karte Tab -->
    <div class="tab-content active" id="tab-karte">
      <div class="karte-layout">
        <!-- Map Container (map + table) -->
        <div class="map-container">
          <!-- Map Panel -->
          <div class="map-panel">
            <div id="map"></div>

            <!-- Layer Visibility Widget -->
            <div class="layer-widget collapsed" id="layer-widget">
              <button class="layer-widget-trigger" id="layer-widget-trigger" title="Kartenebenen">
                <i data-lucide="layers" class="icon"></i>
              </button>
              <div class="layer-widget-panel" id="layer-widget-panel">
                <div class="layer-widget-header" title="Einklappen">
                  <i data-lucide="layers" class="icon"></i>
                  <span>Kartenebenen</span>
                  <i data-lucide="chevron-up" class="icon-sm"></i>
                </div>
                <div class="layer-widget-content">
                  <label class="layer-item">
                    <input type="checkbox" id="layer-buildings" data-layer="buildings" checked>
                    <span class="layer-name">Gebäude</span>
                    <button class="layer-info-btn" data-layer="buildings" title="Layer-Info">
                      <i data-lucide="info" class="icon-sm"></i>
                    </button>
                  </label>
                  <div class="layer-divider"></div>
                  <label class="layer-item">
                    <input type="checkbox" id="layer-oereb" data-layer="ch.swisstopo-vd.stand-oerebkataster">
                    <span class="layer-name">ÖREB Verfügbarkeit</span>
                    <button class="layer-info-btn" data-layer="ch.swisstopo-vd.stand-oerebkataster" title="Layer-Info">
                      <i data-lucide="info" class="icon-sm"></i>
                    </button>
                  </label>
                  <label class="layer-item">
                    <input type="checkbox" id="layer-gwr" data-layer="ch.bfs.gebaeude_wohnungs_register">
                    <span class="layer-name">GWR Gebäudestatus</span>
                    <button class="layer-info-btn" data-layer="ch.bfs.gebaeude_wohnungs_register" title="Layer-Info">
                      <i data-lucide="info" class="icon-sm"></i>
                    </button>
                  </label>
                </div>
                <div class="layer-widget-footer">
                  <span>© Swisstopo</span>
                </div>
              </div>
            </div>

            <div class="basemap-selector" id="basemap-selector">
              <div class="basemap-panel" id="basemap-panel">
                <button class="basemap-option" data-basemap="none">
                  <div class="basemap-thumb basemap-none"><span>Kein HG</span></div>
                </button>
                <button class="basemap-option active" data-basemap="grey">
                  <div class="basemap-thumb basemap-grey"><span>Grau</span></div>
                </button>
                <button class="basemap-option" data-basemap="color">
                  <div class="basemap-thumb basemap-color"><span>Farbig</span></div>
                </button>
                <button class="basemap-option" data-basemap="satellite">
                  <div class="basemap-thumb basemap-satellite"><span>Luftbild</span></div>
                </button>
              </div>
              <button class="basemap-trigger" id="basemap-trigger" title="Hintergrund wechseln">
                <div class="basemap-thumb basemap-grey" id="basemap-trigger-thumb">
                  <span id="basemap-trigger-label">Grau</span>
                  <i data-lucide="chevron-right" class="icon-sm trigger-chevron"></i>
                </div>
              </button>
            </div>

            <!-- Scale Bar -->
            <div class="scale-bar" id="scale-bar">
              <div class="scale-bar-line" id="scale-bar-line"></div>
              <span class="scale-bar-text" id="scale-bar-text">100 m</span>
            </div>

            <button class="table-toggle-btn active" id="table-toggle-btn">
              <i data-lucide="chevron-up" class="icon-sm chevron"></i>
              <span>Tabelle</span>
            </button>
          </div>

          <!-- Table View Panel (hidden by default) -->
          <div class="table-panel visible" id="table-panel">
            <div class="table-resize-handle" id="table-resize-handle">
              <div class="resize-handle-bar"></div>
            </div>
            <div class="table-panel-header">
              <div class="table-search">
                <i data-lucide="search" class="icon-sm"></i>
                <input type="text" id="table-search-input" placeholder="Suchen..." autocomplete="off">
                <button class="table-search-clear" id="table-search-clear" type="button">
                  <i data-lucide="x" class="icon-sm"></i>
                </button>
              </div>
              <div class="table-columns-container">
                <button class="table-columns-btn" id="table-columns-btn" type="button" title="Spalten ein-/ausblenden">
                  <i data-lucide="columns-3" class="icon-sm"></i>
                  <span>Spalten</span>
                  <i data-lucide="chevron-down" class="icon-sm"></i>
                </button>
                <div class="table-columns-dropdown" id="table-columns-dropdown">
                  <div class="columns-dropdown-label">Spalten anzeigen</div>
                  <label class="columns-dropdown-item">
                    <input type="checkbox" data-col="priority" checked>
                    <span>Priorität</span>
                  </label>
                  <label class="columns-dropdown-item">
                    <input type="checkbox" data-col="id" checked disabled>
                    <span>ID</span>
                  </label>
                  <label class="columns-dropdown-item">
                    <input type="checkbox" data-col="name" checked disabled>
                    <span>Name</span>
                  </label>
                  <label class="columns-dropdown-item">
                    <input type="checkbox" data-col="kanton">
                    <span>Kanton</span>
                  </label>
                  <label class="columns-dropdown-item">
                    <input type="checkbox" data-col="portfolio">
                    <span>Portfolio</span>
                  </label>
                  <label class="columns-dropdown-item">
                    <input type="checkbox" data-col="status" checked>
                    <span>Status</span>
                  </label>
                  <label class="columns-dropdown-item">
                    <input type="checkbox" data-col="confidence" checked>
                    <span>Konfidenz</span>
                  </label>
                  <label class="columns-dropdown-item">
                    <input type="checkbox" data-col="errors">
                    <span>Fehlertypen</span>
                  </label>
                  <label class="columns-dropdown-item">
                    <input type="checkbox" data-col="assignee" checked>
                    <span>Zugewiesen</span>
                  </label>
                  <label class="columns-dropdown-item">
                    <input type="checkbox" data-col="updated" checked>
                    <span>Aktualisiert</span>
                  </label>
                </div>
              </div>
              <div class="table-export-container">
                <button class="table-export-btn" id="table-export-btn" type="button">
                  <i data-lucide="download" class="icon-sm"></i>
                  <span>Exportieren</span>
                  <i data-lucide="chevron-down" class="icon-sm"></i>
                </button>
                <div class="table-export-dropdown" id="table-export-dropdown">
                  <div class="export-dropdown-section">
                    <div class="export-dropdown-label">Alle exportieren</div>
                    <button class="export-dropdown-item" data-export="all-csv">Als CSV</button>
                    <button class="export-dropdown-item" data-export="all-xlsx">Als XLSX</button>
                    <button class="export-dropdown-item" data-export="all-geojson">Als GeoJSON</button>
                  </div>
                  <div class="export-dropdown-section export-selection-section" id="export-selection-section" style="display: none;">
                    <div class="export-dropdown-label">Auswahl exportieren</div>
                    <button class="export-dropdown-item" data-export="selection-csv">Als CSV</button>
                    <button class="export-dropdown-item" data-export="selection-xlsx">Als XLSX</button>
                    <button class="export-dropdown-item" data-export="selection-geojson">Als GeoJSON</button>
                  </div>
                </div>
              </div>
              <button class="table-panel-close" id="table-close-btn" type="button">
                <i data-lucide="x" class="icon"></i>
              </button>
            </div>
            <div class="table-panel-content">
              <table class="buildings-table">
                <thead>
                  <tr>
                    <th class="col-checkbox"><input type="checkbox" id="table-select-all-header" title="Alle auf dieser Seite auswählen"></th>
                    <th data-col="priority">Priorität</th>
                    <th data-col="id">ID</th>
                    <th data-col="name">Name</th>
                    <th data-col="kanton" class="col-hidden">Kanton</th>
                    <th data-col="portfolio" class="col-hidden">Portfolio</th>
                    <th data-col="status">Status</th>
                    <th data-col="confidence">Konfidenz</th>
                    <th data-col="errors" class="col-hidden">Fehlertypen</th>
                    <th data-col="assignee">Zugewiesen</th>
                    <th data-col="updated">Aktualisiert</th>
                  </tr>
                </thead>
                <tbody id="table-body">
                  <!-- Populated by JS -->
                </tbody>
              </table>
            </div>
            <div class="table-panel-footer">
              <div class="table-footer-left">
                <span class="table-selection-count" id="table-selection-count"></span>
              </div>
              <div class="table-footer-center">
                <div class="table-pagination" id="table-pagination">
                  <button class="pagination-btn" id="pagination-prev" type="button" disabled>
                    <i data-lucide="chevron-left" class="icon-sm"></i>
                  </button>
                  <div class="pagination-pages" id="pagination-pages"></div>
                  <button class="pagination-btn" id="pagination-next" type="button">
                    <i data-lucide="chevron-right" class="icon-sm"></i>
                  </button>
                </div>
              </div>
              <div class="table-footer-right">
                <span class="table-count" id="table-count">0 Gebäude</span>
                <div class="table-page-size">
                  <select id="table-page-size">
                    <option value="100" selected>100</option>
                    <option value="500">500</option>
                    <option value="1000">1000</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- NO detail panel here anymore -->
      </div>
    </div>

    <!-- Aufgaben Tab -->
    <div class="tab-content" id="tab-aufgaben">
      <div class="aufgaben-layout">
        <div class="kanban-container">
          <div class="kanban-column">
            <div class="kanban-header">
              <span class="kanban-header-icon"><i data-lucide="layers" class="icon"></i></span>
              <span class="kanban-header-title">Backlog</span>
              <span class="kanban-header-count" id="kanban-backlog-count">0</span>
            </div>
            <div class="kanban-cards" id="kanban-backlog">
              <!-- Populated by JS -->
            </div>
          </div>

          <div class="kanban-column">
            <div class="kanban-header">
              <span class="kanban-header-icon"><i data-lucide="play-circle" class="icon"></i></span>
              <span class="kanban-header-title">In Bearbeitung</span>
              <span class="kanban-header-count" id="kanban-inprogress-count">0</span>
            </div>
            <div class="kanban-cards" id="kanban-inprogress">
              <!-- Populated by JS -->
            </div>
          </div>

          <div class="kanban-column">
            <div class="kanban-header">
              <span class="kanban-header-icon"><i data-lucide="help-circle" class="icon"></i></span>
              <span class="kanban-header-title">Abklärung</span>
              <span class="kanban-header-count" id="kanban-clarification-count">0</span>
            </div>
            <div class="kanban-cards" id="kanban-clarification">
              <!-- Populated by JS -->
            </div>
          </div>

          <div class="kanban-column">
            <div class="kanban-header">
              <span class="kanban-header-icon"><i data-lucide="check-circle" class="icon"></i></span>
              <span class="kanban-header-title">Erledigt</span>
              <span class="kanban-header-count" id="kanban-done-count">0</span>
            </div>
            <div class="kanban-cards" id="kanban-done">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Statistik Tab -->
    <div class="tab-content" id="tab-statistik">
      <div class="statistik-content">
        <div class="stat-cards stat-cards-6">
          <div class="stat-card">
            <div class="stat-label">Fortschritt</div>
            <div class="stat-value" id="stat-progress">0/0</div>
            <div class="stat-sublabel" id="stat-progress-pct">0% erledigt</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Datenqualität</div>
            <div class="stat-value" id="stat-quality">0%</div>
            <div class="stat-sublabel">Ø Konfidenz</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Kritisch</div>
            <div class="stat-value error" id="stat-critical">0</div>
            <div class="stat-sublabel">Konfidenz &lt; 50%</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">In Bearbeitung</div>
            <div class="stat-value" id="stat-inprogress">0</div>
            <div class="stat-sublabel">Aktive Aufgaben</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Nicht zugewiesen</div>
            <div class="stat-value warning" id="stat-unassigned">0</div>
            <div class="stat-sublabel">Ohne Bearbeiter</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Überfällig</div>
            <div class="stat-value error" id="stat-overdue">0</div>
            <div class="stat-sublabel">Fälligkeit überschritten</div>
          </div>
        </div>

        <div class="charts-grid">
          <!-- Confidence Distribution -->
          <div class="chart-card">
            <h3 class="chart-title">Konfidenz-Verteilung</h3>
            <div id="chart-confidence"></div>
          </div>

          <!-- Status Distribution -->
          <div class="chart-card">
            <h3 class="chart-title">Status-Verteilung</h3>
            <div id="chart-status"></div>
          </div>

          <!-- Errors by Source -->
          <div class="chart-card">
            <h3 class="chart-title">Abweichungen nach Quelle</h3>
            <div id="chart-source"></div>
          </div>

          <!-- Due Dates -->
          <div class="chart-card">
            <h3 class="chart-title">Fälligkeiten</h3>
            <div id="chart-duedate"></div>
          </div>

          <!-- Tasks per Assignee -->
          <div class="chart-card">
            <h3 class="chart-title">Aufgaben pro Bearbeiter</h3>
            <div id="chart-assignee"></div>
          </div>

          <!-- Priority Distribution -->
          <div class="chart-card">
            <h3 class="chart-title">Prioritäten</h3>
            <div id="chart-priority"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Einstellungen & Workflows Tab -->
    <div class="tab-content" id="tab-settings">
      <div class="settings-content">
        <!-- User Management Section -->
        <div class="settings-section">
          <div class="section-header-with-action">
            <h2 class="settings-section-title section-title-icon"><i data-lucide="users" class="icon-lg"></i> Benutzerverwaltung</h2>
            <button class="btn btn-primary btn-sm" onclick="openModal('modal-invite-user')">
              <i data-lucide="user-plus" class="icon-sm"></i>
              Einladen
            </button>
          </div>
          <table class="users-table">
            <thead>
              <tr>
                <th>Benutzer</th>
                <th>Rolle</th>
                <th>Letzter Login</th>
                <th>Aktionen</th>
              </tr>
            </thead>
            <tbody id="users-table-body">
              <!-- Users will be loaded dynamically -->
            </tbody>
          </table>
        </div>

        <!-- Workflows Section -->
        <div class="settings-section">
          <h2 class="settings-section-title section-title-icon"><i data-lucide="workflow" class="icon-lg"></i> Workflows</h2>
          <p class="section-description">Automatisierte Prozesse zur Datenverarbeitung, -prüfung und Export.</p>
          <div class="workflow-list">
            <div class="workflow-item">
              <div class="workflow-info">
                <div class="workflow-icon"><i data-lucide="play-circle" class="icon-md"></i></div>
                <div class="workflow-details">
                  <span class="workflow-name">Alle Prüfungen ausführen</span>
                  <span class="workflow-description">Führt alle aktiven Prüfregeln auf dem gesamten Gebäudebestand aus.</span>
                </div>
              </div>
              <div class="workflow-meta">
                <span class="workflow-last-run">Letzte Ausführung: <span id="workflow-checks-time">28.01.2026, 14:32</span></span>
                <button class="btn btn-ghost btn-sm workflow-run-btn" id="run-all-checks">
                  <i data-lucide="play" class="icon-sm"></i>
                  Ausführen
                </button>
              </div>
            </div>
            <div class="workflow-item">
              <div class="workflow-info">
                <div class="workflow-icon"><i data-lucide="database" class="icon-md"></i></div>
                <div class="workflow-details">
                  <span class="workflow-name">GWR-Daten anreichern</span>
                  <span class="workflow-description">Ergänzt fehlende Daten aus dem Gebäude- und Wohnungsregister (GWR).</span>
                </div>
              </div>
              <div class="workflow-meta">
                <span class="workflow-last-run">Letzte Ausführung: <span id="workflow-gwr-time">26.01.2026, 09:15</span></span>
                <button class="btn btn-ghost btn-sm workflow-run-btn" id="run-gwr-enrich">
                  <i data-lucide="play" class="icon-sm"></i>
                  Ausführen
                </button>
              </div>
            </div>
            <div class="workflow-item">
              <div class="workflow-info">
                <div class="workflow-icon"><i data-lucide="file-spreadsheet" class="icon-md"></i></div>
                <div class="workflow-details">
                  <span class="workflow-name">Fehlerbericht exportieren</span>
                  <span class="workflow-description">Exportiert alle aktuellen Validierungsfehler als XLSX-Datei.</span>
                </div>
              </div>
              <div class="workflow-meta">
                <span class="workflow-last-run">Letzte Ausführung: <span id="workflow-errors-time">27.01.2026, 09:15</span></span>
                <button class="btn btn-ghost btn-sm workflow-run-btn" id="export-errors">
                  <i data-lucide="download" class="icon-sm"></i>
                  Exportieren
                </button>
              </div>
            </div>
            <div class="workflow-item">
              <div class="workflow-info">
                <div class="workflow-icon"><i data-lucide="history" class="icon-md"></i></div>
                <div class="workflow-details">
                  <span class="workflow-name">Ereignisse exportieren</span>
                  <span class="workflow-description">Exportiert das Aktivitätsprotokoll als CSV-Datei.</span>
                </div>
              </div>
              <div class="workflow-meta">
                <span class="workflow-last-run">Letzte Ausführung: <span id="workflow-events-time">26.01.2026, 16:48</span></span>
                <button class="btn btn-ghost btn-sm workflow-run-btn" id="export-events">
                  <i data-lucide="download" class="icon-sm"></i>
                  Exportieren
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Checking Rules Section -->
        <div class="settings-section">
          <div class="section-header-with-action">
            <h2 class="settings-section-title section-title-icon"><i data-lucide="shield-check" class="icon-lg"></i> Prüfregeln</h2>
            <button class="btn btn-ghost btn-sm" id="download-pruefplan">
              <i data-lucide="download" class="icon-sm"></i>
              Prüfplan (PDF)
            </button>
          </div>
          <p class="section-description">Diese Regeln werden automatisch auf alle Gebäude angewendet.</p>
          <div class="rules-container" id="rules-container">
            <div class="rules-loading">Regeln werden geladen...</div>
          </div>
        </div>
      </div>
    </div>

      </div><!-- /tabs-content -->

      <!-- Shared Detail Panel (moved here from inside tab-karte) -->
      <div class="detail-panel" id="detail-panel">
        <div class="detail-resize-handle" id="detail-resize-handle">
          <div class="resize-handle-bar-vertical"></div>
        </div>
        <div class="detail-content" id="detail-content">
          <div class="detail-header">
            <button class="detail-close-btn" id="detail-close-btn" title="Schliessen">
              <i data-lucide="x" class="icon-sm"></i>
            </button>
            <h2 class="detail-title" id="detail-title">Building Name</h2>
            <p class="detail-subtitle" id="detail-sap-id">SAP ID</p>
          </div>

          <div class="detail-section accordion open" data-accordion="images">
            <button class="accordion-header" type="button">
              <span class="accordion-title">Anhang und Bilder</span>
              <span class="accordion-count" id="images-count"></span>
              <i data-lucide="chevron-down" class="icon-sm accordion-chevron"></i>
            </button>
            <div class="accordion-content">
              <div class="image-widget" id="image-widget">
                <!-- Empty state (shown when no images) -->
                <div class="image-empty-state" id="image-empty-state">
                  <div class="image-empty-icon"><i data-lucide="image" class="icon-lg"></i></div>
                  <p class="image-empty-text">Keine Bilder vorhanden</p>
                  <label class="btn btn-primary btn-sm image-upload-btn">
                    <i data-lucide="plus" class="icon-sm"></i>
                    Datei hochladen
                    <input type="file" id="image-upload-input" multiple hidden>
                  </label>
                </div>
                <!-- Carousel (shown when images exist) -->
                <div class="image-carousel" id="image-carousel" style="display: none;">
                  <div class="carousel-main">
                    <img class="carousel-image" id="carousel-image" src="" alt="Gebäudebild">
                    <!-- Top-left: Filename overlay -->
                    <div class="carousel-filename-overlay" id="carousel-filename"></div>
                    <!-- Top-right: Actions (Add, Download, Fullscreen, Delete) -->
                    <div class="carousel-actions">
                      <label class="carousel-action-btn add" title="Datei hinzufügen">
                        <i data-lucide="plus" class="icon-sm"></i>
                        <input type="file" id="carousel-add-input" multiple hidden>
                      </label>
                      <button class="carousel-action-btn" id="carousel-download" type="button" title="Herunterladen">
                        <i data-lucide="download" class="icon-sm"></i>
                      </button>
                      <button class="carousel-action-btn" id="carousel-fullscreen" type="button" title="Vollbild">
                        <i data-lucide="maximize-2" class="icon-sm"></i>
                      </button>
                      <button class="carousel-action-btn delete" id="carousel-delete" type="button" title="Löschen">
                        <i data-lucide="trash-2" class="icon-sm"></i>
                      </button>
                    </div>
                    <!-- Navigation arrows -->
                    <button class="carousel-nav prev" id="carousel-prev" type="button">
                      <i data-lucide="chevron-left" class="icon-sm"></i>
                    </button>
                    <button class="carousel-nav next" id="carousel-next" type="button">
                      <i data-lucide="chevron-right" class="icon-sm"></i>
                    </button>
                    <!-- Center-bottom: Dot carousel -->
                    <div class="carousel-dots" id="carousel-dots">
                      <!-- Dots populated by JS -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="detail-section accordion open" data-accordion="konfidenz">
            <button class="accordion-header" type="button">
              <span class="accordion-title">Konfidenz <span class="accordion-note">(eventuell löschen)</span></span>
              <i data-lucide="chevron-down" class="icon-sm accordion-chevron"></i>
            </button>
            <div class="accordion-content">
              <div class="confidence-container">
                <div class="confidence-total" id="confidence-total">67%</div>
                <div class="confidence-bars">
                  <div class="confidence-bar-row">
                    <span class="confidence-bar-label">Georef</span>
                    <div class="confidence-bar-track">
                      <div class="confidence-bar-fill" id="bar-georef" style="width: 67%"></div>
                    </div>
                    <span class="confidence-bar-value" id="val-georef">67%</span>
                  </div>
                  <div class="confidence-bar-row">
                    <span class="confidence-bar-label">SAP</span>
                    <div class="confidence-bar-track">
                      <div class="confidence-bar-fill ok" id="bar-sap" style="width: 100%"></div>
                    </div>
                    <span class="confidence-bar-value" id="val-sap">100%</span>
                  </div>
                  <div class="confidence-bar-row">
                    <span class="confidence-bar-label">GWR</span>
                    <div class="confidence-bar-track">
                      <div class="confidence-bar-fill ok" id="bar-gwr" style="width: 100%"></div>
                    </div>
                    <span class="confidence-bar-value" id="val-gwr">100%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="detail-section accordion" data-accordion="fehler">
            <button class="accordion-header" type="button">
              <span class="accordion-title">Fehler</span>
              <span class="accordion-count" id="error-count"></span>
              <i data-lucide="chevron-down" class="icon-sm accordion-chevron"></i>
            </button>
            <div class="accordion-content">
              <table class="error-table" id="error-table">
                <thead>
                  <tr>
                    <th class="col-check-id">ID</th>
                    <th class="col-desc">Beschreibung</th>
                    <th class="col-level">Level</th>
                  </tr>
                </thead>
                <tbody id="error-tbody">
                  <!-- Populated by JS -->
                </tbody>
              </table>
              <div class="error-empty-state" id="error-empty-state" style="display: none;">
                <i data-lucide="check-circle" class="icon-lg"></i>
                <span>Keine Fehler gefunden</span>
              </div>
            </div>
          </div>

          <div class="detail-section accordion open" data-accordion="status">
            <button class="accordion-header" type="button">
              <span class="accordion-title">Zuständigkeiten</span>
              <i data-lucide="chevron-down" class="icon-sm accordion-chevron"></i>
            </button>
            <div class="accordion-content">
              <div class="status-section">
                <div class="status-row">
                  <span class="status-label">Priorität</span>
                  <div class="priority-display" id="priority-display">
                    <!-- Populated by JS -->
                  </div>
                </div>
                <div class="status-row">
                  <span class="status-label">Status</span>
                  <div class="status-display" id="status-display">
                    <!-- Populated by JS -->
                  </div>
                </div>
                <div class="status-row">
                  <span class="status-label">Zugewiesen</span>
                  <div class="assignee-display" id="assignee-display">
                    <!-- Populated by JS -->
                  </div>
                </div>
                <div class="status-row">
                  <span class="status-label">Fälligkeit</span>
                  <div class="duedate-display" id="duedate-display">
                    <!-- Populated by JS -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="detail-section accordion open" data-accordion="datenvergleich">
            <button class="accordion-header" type="button">
              <span class="accordion-title">Korrektur</span>
              <i data-lucide="chevron-down" class="icon-sm accordion-chevron"></i>
            </button>
            <div class="accordion-content">
              <table class="data-table">
                <thead>
                  <tr>
                    <th class="col-attr">Attribut</th>
                    <th class="col-sap">SAP</th>
                    <th class="col-gwr">GWR</th>
                    <th class="col-value">Korrektur</th>
                    <th class="col-match"></th>
                  </tr>
                </thead>
                <tbody id="data-comparison">
                  <!-- Populated by JS -->
                </tbody>
              </table>
              <div class="data-actions">
                <button class="btn btn-ghost btn-sm" id="btn-toggle-fields" type="button">
                  <i data-lucide="chevron-down" class="icon-sm"></i> Mehr Attribute
                </button>
                <button class="data-correct-btn" id="btn-correct" type="button">Daten bearbeiten</button>
                <div class="edit-actions" id="edit-actions" style="display: none;">
                  <button class="edit-cancel-btn" id="btn-edit-cancel" type="button">Abbrechen</button>
                  <button class="edit-save-btn" id="btn-edit-save" type="button">Speichern</button>
                </div>
              </div>
            </div>
          </div>

          <div class="detail-section accordion" data-accordion="kommentare">
            <button class="accordion-header" type="button">
              <span class="accordion-title">Kommentare</span>
              <span class="accordion-count" id="comments-count"></span>
              <i data-lucide="chevron-down" class="icon-sm accordion-chevron"></i>
            </button>
            <div class="accordion-content">
              <div id="comments-list">
                <!-- Populated by JS -->
              </div>
              <div class="comment-input-section">
                <textarea class="comment-input" id="comment-input" placeholder="Kommentar schreiben..." rows="2"></textarea>
                <div class="comment-actions">
                  <button class="btn btn-secondary btn-sm" id="btn-cancel-comment" type="button">Abbrechen</button>
                  <button class="btn btn-primary btn-sm" id="btn-submit-comment" type="button">Speichern</button>
                </div>
              </div>
            </div>
          </div>

          <div class="detail-section accordion" data-accordion="ereignisse">
            <button class="accordion-header" type="button">
              <span class="accordion-title">Ereignisse</span>
              <span class="accordion-count" id="events-count"></span>
              <i data-lucide="chevron-down" class="icon-sm accordion-chevron"></i>
            </button>
            <div class="accordion-content">
              <div class="events-list" id="events-list">
                <!-- Populated by JS -->
              </div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- /content-with-panel -->
  </main>

  <!-- Footer -->
  <footer class="app-footer">
    <div class="footer-version">v0.1.0</div>
    <div class="footer-links">
      <a href="#" class="footer-link-placeholder">API</a>
      <a href="https://github.com/bbl-dres/geo-check" target="_blank" rel="noopener">Quellcode</a>
      <a href="https://www.admin.ch/gov/de/start/rechtliches.html" target="_blank" rel="noopener">Rechtliches</a>
      <a href="mailto:dres@bbl.admin.ch">Kontakt</a>
    </div>
  </footer>

  <!-- Invite User Modal -->
  <div class="modal-overlay" id="modal-invite-user">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Benutzer einladen</h3>
        <button class="modal-close" onclick="closeModal('modal-invite-user')">×</button>
      </div>
      <div class="modal-body">
        <label class="modal-label">E-Mail-Adresse</label>
        <input type="email" class="modal-input" placeholder="name@bbl.admin.ch">

        <label class="modal-label">Rolle</label>
        <select class="modal-select">
          <option value="reader">Leser - Nur Ansicht</option>
          <option value="editor" selected>Bearbeiter - Kann Daten bearbeiten</option>
          <option value="admin">Admin - Voller Zugriff</option>
        </select>

        <label class="modal-label">Nachricht (optional)</label>
        <textarea class="modal-textarea" placeholder="Persönliche Nachricht zur Einladung..."></textarea>
      </div>
      <div class="modal-footer">
        <button class="modal-btn cancel" onclick="closeModal('modal-invite-user')">Abbrechen</button>
        <button class="modal-btn primary">Einladung senden</button>
      </div>
    </div>
  </div>

  <!-- Layer Info Modal -->
  <div id="layer-info-modal" class="layer-info-modal">
    <div class="layer-info-modal-content">
      <div class="layer-info-modal-header">
        <span class="layer-info-modal-title" id="layer-info-modal-title">Layer Information</span>
        <button class="layer-info-modal-close" id="layer-info-modal-close">
          <i data-lucide="x" class="icon-sm"></i>
        </button>
      </div>
      <div class="layer-info-modal-body" id="layer-info-modal-body">
        <div class="layer-info-loading">Laden...</div>
      </div>
    </div>
  </div>

  <!-- Map Context Menu (Right-Click) -->
  <div id="map-context-menu" class="map-context-menu">
    <div class="context-menu-item context-menu-coords" id="context-menu-coords" title="Klicken zum Kopieren">
      <i data-lucide="copy" class="icon-sm"></i>
      <span id="context-menu-coords-text">47.37623, 8.53048</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" id="context-menu-share">
      <i data-lucide="share-2" class="icon-sm"></i>
      <span>Teilen</span>
    </div>
    <div class="context-menu-item" id="context-menu-center">
      <i data-lucide="crosshair" class="icon-sm"></i>
      <span>Hier zentrieren</span>
    </div>
    <div class="context-menu-item" id="context-menu-nearest">
      <i data-lucide="map-pin" class="icon-sm"></i>
      <span>Nächstes Objekt</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" id="context-menu-google-maps">
      <i data-lucide="map" class="icon-sm"></i>
      <span>In Google Maps öffnen</span>
    </div>
    <div class="context-menu-item" id="context-menu-swisstopo">
      <i data-lucide="mountain" class="icon-sm"></i>
      <span>In Swisstopo öffnen</span>
    </div>
    <div class="context-menu-item" id="context-menu-google-earth">
      <i data-lucide="globe" class="icon-sm"></i>
      <span>In Google Earth 3D öffnen</span>
    </div>
  </div>

  <!-- Mapbox GL JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>

  <!-- Application JavaScript (ES Modules) -->
  <script type="module" src="js/main.js"></script>
</body>
</html>
